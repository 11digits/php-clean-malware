<?php
  ini_set('memory_limit', '-1'); ## Avoid memory errors (i.e in foreachloop)
  error_reporting(E_ALL);

  if ( !function_exists('glob_recursive'))
  {
     function glob_recursive($pattern, $flags = 0)
     {
       $files = glob($pattern, $flags);
       foreach (glob(dirname($pattern).'/*', GLOB_ONLYDIR|GLOB_NOSORT) as $dir)
       {
         $files = array_merge($files, glob_recursive($dir.'/'.basename($pattern), $flags));
       }
    return $files;
    }
  }

  function checkOpenTag($contents) {
    $a = strpos($contents, ';?><?php');
    $b = strpos($contents, '; ?><?php');

    $x = strpos($contents, '<?php $');

    if ($a !== false && $x !== false) {
      return substr($contents, 0, $a + 3);
    }

    if ($b !== false && $x !== false) {
      return substr($contents, 0, $b + 4);
    }

    return false;
  }


  if (sizeof($argv) <3) {
    echo "\n\n".'USAGE: '."\n".'php pcm.php [PATH RELATIVE TO CURRENT FOLDER OR ABSOLUTE] [--auto|--signature] [--fix]'."\n\n";
    exit();
  }

  $site = $argv[1];

  echo 'WEBSITE: '.$site."\n";

  foreach (glob_recursive($site."/*.php") as $filename) {
      $content = file_get_contents($filename);
      
      if (isset($argv)) {
          for ($i=2; $i<sizeof($argv);$i++) {
            if ($argv[$i] == '--signature') {
              echo 'SIGNATURE MODE'."\n";

              foreach (glob_recursive("signatures/*.sig") as $sig)
              {
                $r = file_get_contents($sig);

                if (strpos($content, $r) !== false) {
                    echo $filename."\n";
                    echo 'Sig tag hack detected, '.$sig.' '."\n";

                    if (isset($argv)) {
                        for ($i=2; $i<sizeof($argv);$i++) {
                          if ($argv[$i] == '--fix') {
                            echo $filename." fixed \n";
                            file_put_contents($filename, str_replace($replace,"",$content));
                          }
                        }
                    }
                }
              }

              echo "All done \n";
              exit();
            }

            if ($argv[$i] == '--auto') {
              echo 'AUTO MODE, BE CAREFULL WITH FIX!'."\n";
              $r = checkOpenTag($content);

              if ($r !== false) {
                echo $filename."\n";
                echo 'Pre tag hack detected'."\n";

                if (isset($argv)) {
                    for ($i=2; $i<sizeof($argv);$i++) {
                      if ($argv[$i] == '--fix') {
                        echo $filename." fixed \n";
                        file_put_contents($filename, str_replace($r,"",$content));
                      }
                    }
                }
              }

              echo "All done \n";                    
              exit();
            }
          }
      }
  }
  
?>
